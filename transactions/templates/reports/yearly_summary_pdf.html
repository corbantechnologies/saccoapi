<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <title>{{ member.member_no }} - Financial Summary {{ year }}</title>
        <style>
            @page {
                size: A4;
                margin: 1.2cm;

                @top-center {
                    content: "Tamarind SACCO";
                    font-size: 10pt;
                    font-weight: bold;
                }

                @bottom-center {
                    content: "Page " counter(page) " of " counter(pages);
                    font-size: 9pt;
                    color: #666;
                }
            }

            body {
                font-family: 'Segoe UI', Tahoma, sans-serif;
                color: #333;
                line-height: 1.5;
                font-size: 11pt;
            }

            .container {
                max-width: 100%;
            }

            .header {
                text-align: center;
                margin-bottom: 25px;
                padding-bottom: 15px;
                border-bottom: 3px solid #1e40af;
            }

            .logo {
                height: 70px;
                margin-bottom: 10px;
            }

            .title {
                margin: 0;
                font-size: 26px;
                color: #1e40af;
            }

            .subtitle {
                margin: 8px 0;
                font-size: 14px;
                color: #666;
            }

            .info-box {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
                display: flex;
                justify-content: space-between;
                flex-wrap: wrap;
                font-size: 12pt;
            }

            .info-label {
                font-weight: 600;
                color: #1e40af;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin: 18px 0;
                font-size: 10pt;
            }

            th {
                background: #1e40af;
                color: white;
                padding: 10px 8px;
                text-align: left;
                font-weight: 600;
                font-size: 10pt;
            }

            td {
                padding: 8px;
                border-bottom: 1px solid #eee;
                vertical-align: top;
            }

            .total-row td {
                background: #f0f7ff;
                font-weight: bold;
                font-size: 11pt;
            }

            .section {
                margin-top: 35px;
                page-break-inside: avoid;
            }

            .section h3 {
                color: #1e40af;
                border-bottom: 2px solid #3b82f6;
                padding-bottom: 8px;
                margin-bottom: 15px;
                font-size: 16pt;
            }

            .tx-list {
                margin: 8px 0;
                padding-left: 20px;
            }

            .tx-item {
                margin: 4px 0;
                font-size: 9pt;
            }

            .tx-amount {
                font-weight: 600;
                color: #16a34a;
            }

            .footer {
                margin-top: 50px;
                text-align: center;
                font-size: 10px;
                color: #888;
                border-top: 1px solid #eee;
                padding-top: 15px;
            }

            @media print {
                body {
                    -webkit-print-color-adjust: exact;
                }
            }
        </style>
    </head>

    <body>

        <div class="container">

            <!-- Header -->
            <div class="header">
                <img src="{{ logo_url }}" alt="Logo" class="logo">
                <h1 class="title">Annual Financial Summary</h1>
                <p class="subtitle">Year: {{ year }} | Generated: {{ generated_at }}</p>
            </div>

            <!-- Member Info -->
            <div class="info-box">
                <div><span class="info-label">Member No:</span> {{ member.member_no }}</div>
                <div><span class="info-label">Name:</span> {{ member.get_full_name }}</div>
                <div><span class="info-label">Email:</span> {{ member.email|default:"N/A" }}</div>
                <div><span class="info-label">Phone:</span> {{ member.phone|default:"N/A" }}</div>
            </div>

            <!-- Monthly Breakdown -->
            {% for month in data.monthly_summary %}
            <div class="section">
                <h3>{{ month.month }}</h3>

                <!-- Savings -->
                <table>
                    <tr>
                        <th colspan="3">Savings</th>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Deposits</th>
                    </tr>
                    {% for s in month.savings.by_type %}
                    <tr>
                        <td><strong>{{ s.type }}</strong></td>
                        <td><strong>{{ s.amount|floatformat:2 }}</strong></td>
                        <td>
                            <div class="tx-list">
                                {% for d in s.deposits %}
                                <div class="tx-item">
                                    {{ d.type }}: <span class="tx-amount">KES {{ d.amount|floatformat:2 }}</span>
                                </div>
                                {% empty %}
                                <em>No deposits</em>
                                {% endfor %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>Total Savings</strong></td>
                        <td colspan="2"><strong>KES {{ month.savings.total_savings|floatformat:2 }}</strong></td>
                    </tr>
                </table>

                <!-- Ventures -->
                <table>
                    <tr>
                        <th colspan="4">Ventures</th>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <th>Deposits</th>
                        <th>Payments</th>
                        <th>Net</th>
                    </tr>
                    {% for v in month.ventures.by_type %}
                    {% with dep_total=0 %}
                    {% for d in v.venture_deposits %}{% with dep_total=dep_total|add:d.amount %}{% endwith %}{% endfor %}
                    {% with pay_total=0 %}
                    {% for p in v.venture_payments %}{% with pay_total=pay_total|add:p.amount %}{% endwith %}{% endfor %}
                    {% with net=dep_total|add:pay_total|floatformat:2 %}
                    <tr>
                        <td><strong>{{ v.venture_type }}</strong></td>
                        <td>
                            <div class="tx-list">
                                {% for d in v.venture_deposits %}
                                <div class="tx-item"><span class="tx-amount">+{{ d.amount|floatformat:2 }}</span></div>
                                {% empty %}
                                <em>None</em>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <div class="tx-list">
                                {% for p in v.venture_payments %}
                                <div class="tx-item"><span class="tx-amount">-{{ p.amount|floatformat:2 }}</span></div>
                                {% empty %}
                                <em>None</em>
                                {% endfor %}
                            </div>
                        </td>
                        <td><strong>KES {{ net }}</strong></td>
                    </tr>
                    {% endwith %}
                    {% endwith %}
                    {% endwith %}
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>Net Ventures</strong></td>
                        <td colspan="3"><strong>KES {{ month.ventures.net_venture|floatformat:2 }}</strong></td>
                    </tr>
                </table>

                <!-- Loans -->
                <table>
                    <tr>
                        <th colspan="5">Loans</th>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <th>Disbursed</th>
                        <th>Repaid</th>
                        <th>Interest</th>
                        <th>Outstanding</th>
                    </tr>
                    {% for l in month.loans.by_type %}
                    <tr>
                        <td><strong>{{ l.loan_type }}</strong></td>
                        <td>
                            <div class="tx-list">
                                {% for d in l.total_amount_disbursed %}
                                <div class="tx-item"><span class="tx-amount">+{{ d.amount|floatformat:2 }}</span></div>
                                {% empty %}
                                <em>None</em>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <div class="tx-list">
                                {% for r in l.total_amount_repaid %}
                                <div class="tx-item"><span class="tx-amount">-{{ r.amount|floatformat:2 }}</span></div>
                                {% empty %}
                                <em>None</em>
                                {% endfor %}
                            </div>
                        </td>
                        <td>
                            <div class="tx-list">
                                {% for i in l.total_interest_charged %}
                                <div class="tx-item"><span class="tx-amount">{{ i.amount|floatformat:2 }}</span></div>
                                {% empty %}
                                <em>None</em>
                                {% endfor %}
                            </div>
                        </td>
                        <td><strong>KES {{ l.total_amount_outstanding|floatformat:2 }}</strong></td>
                    </tr>
                    {% endfor %}
                    <tr class="total-row">
                        <td><strong>Totals</strong></td>
                        <td><strong>{{ month.loans.total_loans_disbursed|floatformat:2 }}</strong></td>
                        <td><strong>{{ month.loans.total_loans_repaid|floatformat:2 }}</strong></td>
                        <td><strong>{{ month.loans.total_interest_charged|floatformat:2 }}</strong></td>
                        <td><strong>{{ month.loans.total_loans_outstanding|floatformat:2 }}</strong></td>
                    </tr>
                </table>
            </div>
            {% endfor %}

            <!-- YEARLY SUMMARY -->
            <div class="section">
                <h3>Yearly Summary ({{ year }})</h3>
                <table>
                    <tr>
                        <th>Category</th>
                        <th>Amount (KES)</th>
                    </tr>
                    <tr>
                        <td>Total Savings</td>
                        <td class="total-row">{{ data.summary.total_savings|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Venture Deposits</td>
                        <td>{{ data.summary.total_venture_deposits|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Venture Payments</td>
                        <td>{{ data.summary.total_venture_payments|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Net Ventures</td>
                        <td class="total-row">{{ data.summary.total_ventures_net|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Loans Disbursed</td>
                        <td>{{ data.summary.total_loans_disbursed|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Loans Repaid</td>
                        <td>{{ data.summary.total_loans_repaid|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Interest Charged</td>
                        <td>{{ data.summary.total_interest_charged|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Outstanding Loans</td>
                        <td class="total-row">{{ data.summary.total_loans_outstanding|floatformat:2 }}</td>
                    </tr>
                </table>
            </div>

            <!-- CHART OF ACCOUNTS -->
            <div class="section">
                <h3>Chart of Accounts</h3>
                <table>
                    <tr>
                        <th>Account</th>
                        <th>Amount (KES)</th>
                    </tr>
                    <tr>
                        <td>Total Savings</td>
                        <td>{{ data.chart_of_accounts.total_savings|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Total Ventures (Net)</td>
                        <td>{{ data.chart_of_accounts.total_ventures|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <td>Total Loans Outstanding</td>
                        <td>{{ data.chart_of_accounts.total_loans|floatformat:2 }}</td>
                    </tr>
                </table>

                <h4>Savings by Type</h4>
                <table>
                    <tr>
                        <th>Type</th>
                        <th>Amount</th>
                    </tr>
                    {% for s in data.chart_of_accounts.total_savings_by_type %}
                    <tr>
                        <td>{{ s.type }}</td>
                        <td>{{ s.amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </table>

                <h4>Ventures by Type</h4>
                <table>
                    <tr>
                        <th>Type</th>
                        <th>Net</th>
                    </tr>
                    {% for v in data.chart_of_accounts.total_ventures_by_type %}
                    <tr>
                        <td>{{ v.venture_type }}</td>
                        <td>{{ v.net_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </table>

                <h4>Loans by Type</h4>
                <table>
                    <tr>
                        <th>Type</th>
                        <th>Outstanding</th>
                    </tr>
                    {% for l in data.chart_of_accounts.total_loans_by_type %}
                    <tr>
                        <td>{{ l.loan_type }}</td>
                        <td>{{ l.total_outstanding_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Â© {{ year }} Tamarind SACCO | All rights reserved | Confidential Document</p>
                <p>For inquiries: <a href="mailto:finance@wananchimali.com">finance@wananchimali.com</a></p>
            </div>

        </div>
    </body>

</html>